name: CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      arangodb:
        image: arangodb/arangodb:latest
        ports:
          - 8529:8529
        options: >-
          --name arangodb
          --health-cmd="arangosh --server.endpoint tcp://localhost:8529 \
          --server.username root --server.password pass \
          --javascript.execute-string '1'"
          --health-interval=10s --health-timeout=5s --health-retries=5
        env:
          ARANGO_ROOT_PASSWORD: pass
        command: --experimental-vector-index
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: snok/install-poetry@v1
        with:
          virtualenvs-create: false
      - run: poetry install
      - run: docker build --no-cache -t ha-rag-bridge:ci .
      - run: |
          MAX_IMAGE_SIZE_MB=800  # Maximum allowed Docker image size in MB
          docker images ha-rag-bridge:ci | awk -v max_size="$MAX_IMAGE_SIZE_MB" '$7+0 < max_size'
      - run: poetry run pytest
      - run: docker exec arangodb arangosh --server.endpoint tcp://localhost:8529 --server.username root --server.password pass --javascript.execute-string 'db._create("embeddings")'
      - run: docker run --network host -e ARANGO_URL=http://localhost:8529 -e ARANGO_USER=root -e ARANGO_PASS=pass ha-rag-bridge:ci ha-rag-bootstrap --reindex embeddings
